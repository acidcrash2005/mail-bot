# План: Mail-to-Telegram Bot

## Описание
Node.js приложение для мониторинга Gmail, перевода писем на русский и пересылки в Telegram.

---

## Архитектура

```
┌─────────────┐     ┌──────────────┐     ┌─────────────┐     ┌──────────────┐
│   Gmail     │────▶│   Mail Bot   │────▶│  Translator │────▶│   Telegram   │
│   (IMAP)    │     │   (Node.js)  │     │  (Free AI)  │     │   Channel    │
└─────────────┘     └──────────────┘     └─────────────┘     └──────────────┘
```

---

## Компоненты

### 1. Gmail интеграция
- **Библиотека**: `imap` или `imapflow` (современнее)
- **Авторизация**: OAuth2 через Google Cloud Console или App Password
- **Задача**:
  - Подключение к Gmail по IMAP
  - Поиск непрочитанных писем от `702mariana@gmail.com`
  - Извлечение текста и вложений
  - Пометка обработанных писем как прочитанных

### 2. Обработка писем
- **Библиотека**: `mailparser` для парсинга email
- **Задача**:
  - Парсинг HTML/текста письма
  - Извлечение вложений (PDF, изображения, документы)
  - Сохранение вложений во временную папку

### 3. Перевод на русский (бесплатные варианты)
| Вариант | Плюсы | Минусы |
|---------|-------|--------|
| **LibreTranslate** (self-hosted) | Полностью бесплатно, без лимитов | Нужен сервер или Docker |
| **Lingva Translate** | Бесплатный API | Публичные инстансы могут быть нестабильны |
| **Google Translate** (unofficial) | Хорошее качество | Неофициальный, может сломаться |
| **DeepL Free API** | Отличное качество | 500,000 символов/месяц |

**Рекомендация**: `Lingva Translate` или `DeepL Free API`

### 4. Telegram интеграция
- **Библиотека**: `node-telegram-bot-api` или `telegraf`
- **Задача**:
  - Отправка текста сообщения
  - Отправка файлов/документов
  - Обработка лимитов Telegram (файлы до 50MB)

### 5. Планировщик
- **Библиотека**: `node-cron`
- **Интервал**: каждые 1-5 минут (настраиваемо)

---

## Структура проекта

```
mail-bot/
├── src/
│   ├── index.js           # Точка входа
│   ├── config.js          # Конфигурация
│   ├── services/
│   │   ├── gmail.js       # Работа с Gmail IMAP
│   │   ├── translator.js  # Перевод текста
│   │   └── telegram.js    # Отправка в Telegram
│   └── utils/
│       └── logger.js      # Логирование
├── .env                   # Переменные окружения (секреты)
├── .env.example           # Пример переменных
├── package.json
└── README.md
```

---

## Переменные окружения (.env)

```env
# Gmail
GMAIL_USER=your-email@gmail.com
GMAIL_APP_PASSWORD=xxxx-xxxx-xxxx-xxxx

# Telegram
TELEGRAM_BOT_TOKEN=123456:ABC-DEF...
TELEGRAM_CHAT_ID=-100123456789

# Фильтр
FILTER_FROM_EMAIL=702mariana@gmail.com

# Планировщик
CHECK_INTERVAL_MINUTES=2
```

---

## Настройка Gmail

1. Включить IMAP в настройках Gmail
2. Включить 2FA для аккаунта Google
3. Создать App Password:
   - Google Account → Security → 2-Step Verification → App passwords
   - Создать пароль для "Mail"

---

## Настройка Telegram

1. Создать бота через @BotFather
2. Получить токен бота
3. Создать канал и добавить бота как администратора
4. Получить Chat ID канала (через @userinfobot или API)

---

## Зависимости (package.json)

```json
{
  "dependencies": {
    "imapflow": "^1.0.0",
    "mailparser": "^3.0.0",
    "node-telegram-bot-api": "^0.65.0",
    "node-cron": "^3.0.0",
    "dotenv": "^16.0.0",
    "axios": "^1.6.0"
  }
}
```

---

## Логика работы

```
1. Запуск приложения
   ↓
2. Cron: каждые N минут
   ↓
3. Подключение к Gmail IMAP
   ↓
4. Поиск: FROM:702mariana@gmail.com + UNSEEN
   ↓
5. Для каждого письма:
   ├─ Парсинг содержимого
   ├─ Извлечение вложений
   ├─ Перевод текста на русский
   ├─ Отправка в Telegram:
   │   ├─ Текст сообщения
   │   └─ Файлы (если есть)
   └─ Пометка письма как прочитанного
   ↓
6. Закрытие соединения
   ↓
7. Ожидание следующего запуска cron
```

---

## Этапы разработки

### Этап 1: Базовая настройка
- [ ] Инициализация проекта (npm init)
- [ ] Установка зависимостей
- [ ] Создание структуры папок
- [ ] Настройка конфигурации и .env

### Этап 2: Gmail модуль
- [ ] Подключение к IMAP
- [ ] Поиск писем по фильтру
- [ ] Парсинг писем и вложений
- [ ] Тестирование на реальной почте

### Этап 3: Telegram модуль
- [ ] Создание бота
- [ ] Отправка текстовых сообщений
- [ ] Отправка файлов
- [ ] Тестирование

### Этап 4: Перевод
- [ ] Интеграция с выбранным API
- [ ] Обработка ошибок перевода
- [ ] Fallback на оригинальный текст

### Этап 5: Интеграция
- [ ] Связывание всех модулей
- [ ] Настройка cron
- [ ] Тестирование полного цикла

### Этап 6: Продакшен
- [ ] Логирование
- [ ] Обработка ошибок
- [ ] Graceful shutdown
- [ ] Документация

---

## Альтернативные подходы

### Вместо IMAP — Gmail API
- Плюсы: официальный API, push-уведомления
- Минусы: сложнее настройка OAuth2

### Вместо Cron — IMAP IDLE
- Плюсы: мгновенные уведомления о новых письмах
- Минусы: нужно держать соединение открытым

---

## Оценка сложности

| Компонент | Сложность |
|-----------|-----------|
| Gmail IMAP | Средняя |
| Парсинг писем | Низкая |
| Telegram бот | Низкая |
| Перевод | Низкая |
| Cron | Низкая |

---

## Возможные проблемы

1. **Gmail блокирует подключение** → Использовать App Password
2. **Telegram лимит на файлы (50MB)** → Сжатие или предупреждение
3. **Сбой перевода** → Fallback на оригинал
4. **Дубликаты сообщений** → Помечать письма как прочитанные сразу
